<html><head><title>YaST2 Users module proposal</title></head>
<body>
<h1>YaST2: Users configuration module</h1>

<h2>What is the current state (SL 8.1)</h2>
The module does what it should, it manages users and groups.
The current documentation says:

<p>
Basic module abilities:
<ul>
<li>add, remove and edit users
<li>add, remove and edit groups
</ul>

User attributes:
<ul>
<li>name
<li>password
<li>uid (UID currently cannot be changed)
<li>full name
<li>group (groups)
<li>shell
</ul>

Group attributes:
<ul>
<li>name
<li>gid
<li>users
<li>password access
</ul>

System attributes
<ul>
<li>defaults from /etc/defaults/useradd
<li>password changing and warning limits
</ul>

Current workflow (it can be found at 
<a href="http://lide.suse.cz/~~jsuchome/users/workflow-old.png">http://lide.suse.cz/~~jsuchome/users/workflow-old.png</a>):
<!--
<p>
<img src="workflow-old.png"> -->

<p>
The workflow seems to be good. It is simple and transparent, it doesn't need
to be reworked.


<h2>The problems of current state</h2>

The data structure is very dark and dirty. Some structures are generated many
times and no one can clearly see where and when is something modified.
This also causes module to be slow with a high load (many users etc.).
The sources contain 6 modules, which are imported by themselves in a strange
way. Only one of them (Users.ycp) is imported by other module (Installation).

<hr>
<h2>What has to be done</h2>

<h3>1. Rewriting the old module</h3>

All should be rewritten in a standard way. It would be good to have one module,
providing standard Read, Write, Summary, Import and Export functions.
<p>
It is necessary to have some Add, Edit, Delete functions, which could be run
from other modules (and can be used by the new command line interface). These
functions should provide almost all the functionality the Users module has - 
adding, editing and deleting users and groups.
<p>
There is a need to have good data structure, which could describe the system
state and which would be stable as much as possible.


<h3>2. New features</h3>

<h4>2.1 Main features to 8.2</h4>

<ul>
<li>
Module should handle more "user sources", such as users (and groups) from NIS 
(this is aviabe now), Samba or LDAP. Support for LDAP is the feature for 8.2.
<li>
There should be some dialog (invoked from Summary dialog) for setting the 
default values used for adding new users/groups
(see <a href="http://bugzilla.suse.de/show_bug.cgi?id=14129">http://bugzilla.suse.de/show_bug.cgi?id=14129</a>).
</ul>

<h4>2.2 Minor fixes and enhancements</h4>

<ul>
<li>
There should be some more descriptive label for the checkbox in "Add fist user
dialog". Instead of current "Forward root's mail to this user", we can use e.g.
"This user will recieve system (root's) mail."
<li>
If it makes some sense, there could be a possibility for creating own group for
a new user by checking checkbox in "Add user dialog".
<li>
When editing or creating groups, only appropriate users should have been shown 
(e.g. local group -> show only local users, and also the other way).
<li>
Currently the UID cannot be edited (see bug 16084). Does it make sense to allow
this?
<li>
Instead of "First name" and "Last name" entries, there could (and should?) be
used just one entry called "Name", "Whole Name", "Description" or "Comment".
<li>
Currently there cannot be edited non-local user settings. But if the NIS server
enables e.g. password change, it should (?) be editable also from client's
users-module.
</ul>


<hr>
<h2>Implementation</h2>

<h3>1. New workflow</h3>

New workflow (can be found at 
<a href="http://lide.suse.cz/~~jsuchome/users/workflow-new.png">
http://lide.suse.cz/~~jsuchome/users/workflow-new.png</a>):
<!--<p>
<img src="workflow-new.png"> -->
<p>
There are not big changes, only two new popups or dialogs and some new widgets
in Summary dialog.

<h4>1.1 Modified dialogs</h4>

<ul>
<li>
Summary dialog (<a href="http://lide.suse.cz/~~jsuchome/users/summary-dialog.png">http://lide.suse.cz/~~jsuchome/users/summary-dialog.png</a>):
<!--<p>
<img src="summary-dialog.png"> -->
<p>
This dialog should provide multiple views to sets of users (local/system/...).
So there is a new Menubutton for seting such view. New "Customize view" button
will open the Customize popup. 
In the new Summary dialog will also be the "Defaults" Pushbutton, opening the
Defaults dialog.

<li>
Defaults dialog
(<a href="http://lide.suse.cz/~~jsuchome/users/defaults-dialog.png">http://lide.suse.cz/~~jsuchome/users/defaults-dialog.png</a>)
<!--<p>
<img src="defaults-dialog.png"> -->
<p>

Here will be editable the deafault settings for new users, such as default
group, default shell, etc. In the helptext there should be description of each
entry. See also http://bugzilla.suse.de/show_bug.cgi?id=14129.

<li>
Customize popup
(<a href="http://lide.suse.cz/~~jsuchome/users/customize-popup.png">http://lide.suse.cz/~~jsuchome/users/customize-popup.png</a>)
<!--<p>
<img src="customize-popup.png"> -->
<p>

In this popup user can customize the view of the users set. (He can e.g. set to
view only local and NIS users.)
</ul>

<h3>2. The files</h3>

<!--
These files are present in the 8.1 version:
<p>
<i>The modules:</i>
<ul>
<li>
Accounts.ycp:
    (doesn't do anything)
<li>
UserAddDefs.ycp: 
    Handle all settings from the files /etc/defaults/useradd, /etc/shells.
<li>
UserDefs.ycp:
    Handle user defaults and system settings.
<li>
UserCache.ycp:
    Handle all settings from the files /etc/{passwd,shadow,gshadow,groups}.
<li>
UserWriteStack.ycp
    This module handles a stack that contains all system changes executed
    by finishing the user module.
<li>
Users.ycp
    Handle users functions.
</ul>
    
<i>The clients:</i>
<ul>
<li>
users.ycp:
    Main client file
<li>
users_auto.ycp:
    Client for autoinstallation (doesn't work)
<li>
users_write.ycp:
    Writing only client
<li>
inst_root.ycp:
    During installation, it displays two input fields for the root's password.
<li>
inst_user.ycp:
    Start user management module from within installation workflow.
</ul>

<i>Other files:</i>
<ul>
<li>
help.ycp:
    The helptexts
<li>
ui.ycp:
    Screens and UI routines for the users module
<li>
passwd.ycp:
    System users translations
<li>
accounts.ycp:
    Accounts predefined by initial /etc/passwd
</ul>
-->

<h4>2.1 The modules</h4>

I'd like to reduce the number of modules, there should remain only Users.ycp
and UserCache.ycp (former UserSettings.ycp). The Users.ycp module should be
small (and readable), it will include global variables and the main functions,
other functions will be in the include-files.

<p>
<i>2.1.1 Users.ycp</i>

<ul>
<li>variables for handling default values for user adding (/etc/defaults/useradd)
<p>
These are:
<pre>
map useradd_defaults  = $[];
integer pass_inact_days = -1;
string pass_expire_date = "";
string default_home = "/home";
string default_home = "/bin/bash";
</pre>

with the main functions ReadLoginDefaults() and WriteLoginDefaults().

<p>
<li>other system and security constants (/etc/login.defs)
<p>
These are constants like:
<pre>
string valid_logname_chars  = "0123456789abcdefghijklmnopqrstuvwxyz-_";
integer max_uid = = 60000;
integer max_system_uid  = 500;
symbol encryption = `des
</pre>

They are read in function ReadSystemDefaults().

<p>
<li>all variables, describing system state
<p>
Global sets of users and groups:
<pre>
global map users = $[
    `system:    $[],
    `local:     $[],
    `nis:       $[]];
global map groups = $[];
</pre>
The global user map contains sections with maps containing users of certain
type. The inner maps are idexed by uid (which is unique). The items of these
(inner) maps are the users's maps, which gather all needed data for one user. 
An example for one entry of users:

<pre>
users = $[
    `local:$[
        500 :$[
             "exist":true, "fullname":"Hans H", "gid":100, "home":"/local/hh",
             "org_home":"/local/hh", "password":"x","shell":"/bin/bash",
             "uid":500, "username":"hh",
             "shadow":$[
                "expire":0, "inact":-1, "last_change":11984, "max":99999,
                "min":0, "warn":7]
        ],
        501 : ...
    ]
]
</pre>

There will be also "modifed" flag, with values `nothing, `edit, `add, `delete.
<!--
The "type" flag points to the user type (the values will be `local, `system,
`nis, `ldap - the `passwd value means that user is contained in /etc/passwd).
-->
For different kind of users (LDAP) the map can contain additional needed
informations (like "ldap_base").

<p>
<li>other descriptive variables
<pre>
global map users_by_name = $[] - helper structure, data are organized in 
similar way as in "users" structure, but sorted by name, not by uid
global map groups_by_name = $[]; 
global map user_in_work = $[]; - actual user's map
global map group_in_work = $[];
global boolean is_nis_master = false;
global boolean is_ldap_server = false;
global string base_dir = "/etc";  -- can be changed for NIS server
global list all_shells = [];
global string root_mail = "";
string rootPassword = "";
global list user_custom_sets = [`local, `nis] - user's customized view, it will
be saved to file for future use
global list group_custom_sets = [`local];
</pre>

<li>main functions of Users.ycp

<pre>
Read
Write
Summary
Import
Export
Add,
Edit,
Delete,
Commit
</pre>

</ul>


<i>2.1.2 UserCache.ycp</i>
<p>
This module will provide some helper functions for managing the tables lists, 
for checks etc. (See function names, they are self-descriptive.)
<ul><li>
"cache" variables

<pre>
global map homelists = $[]; - the map of lists of home directories
global map usernamelist = [];

global map itemlist = []; - the map of lists of items showed in the table

global list user_itemlist = []; - the list of items in current view
global list user_custom_sets = [`local, `nis ]; - the customized view
</pre>
These maps are organized same way as the global user/group map is.
<br>
The idea is, that the lists of homes, usernames and tableitems will be created
in some initialization time and when user does some minor change, these lists
will be changed only at the place, where it is necessary (in current state,
these lists are rebuilded again after any change).
<p>
<li>
actual user/group informations
<pre>
global symbol user_type = `local; - type of the current user
global symbol group_type = `system;
global list current_users = $[]; 
</pre>

The last map describes the current view, (e.g. current_users = [ `local, `nis ])
</ul>
                                        
<h4>2.2 The clients and other files</h4>

<i>wizard.ycp</i>
<p>
Here the sequences are defined.
<p>
<i>users.ycp</i>
<p>
The client: main sequence is invoked. 
According to the start of client, the main dialog is defined (it can be 
usersUsersDialog, usersGroupsDialog, but also the Edit dialog, which is used as
the main one during installation).
<p>

<i>users_auto.ycp </i>
<p>

The working version of autoinstallation client has to be done...
<p>

<i>users_write.ycp</i>
<p>
Write only client. Together with the users_auto.ycp will be rewriten with the 
use of the skeleton file.

<p>
<i>inst_root.ycp</i> 
<p>

This client is used only for setting root's password during installation.
<p>

<i>inst_user.ycp</i> 
<p>

This client invokes "Add first user" dialog for definition of one user.
If the button ("Additional...") is pressed, the users.ycp client is called.
<p>
 
<i>complex.ycp, dialogs.ycp</i>
<p>

Definition of dialogs. All function from UserCache module are called from
here.
<p>

<i>routines.ycp</i> - included by Users.ycp
<p>

Here will be the functions, called only once during
initialization (from Users::Read) and during finalization (from Users::Write
function).
<p>

<h4>2.3 The "file workflow"</h4>

For including and imports, see
<a href="http://lide.suse.cz/~~jsuchome/users/file-workflow.png">http://lide.suse.cz/~~jsuchome/users/file-workflow.png</a>
<!--<img src="file-workflow.png"> -->

<h3>3. The functions</h3>

<!--
Q: Should be used one big map of users, with flags like `local, `system, `nis,
`smb etc. OR one map for each type of source - local_users, nis_users etc.?
The second solution looks better, for most of time should the module work with
only one type of users. Each user would be then identified by unique existence
in specified map (and here by ID, of course).
-->

<p>
<i>Users::Read</i>
<p>

Here the read functions from routines.ycp are called to fill the main data
structures.
<p>

<i>Users::Write</i>
<p>

All the affected maps are scanned, and for the users/group with appropriate
flag (changed/added/deleted), the write function (from routines.ycp) is run.
<p>

<!--
Group maps must be checked before user maps, otherwise following problem can
appear: user wants to create group (say, group "G" ;-)) and a user "hh_user"
belonging to the group G. But the user maps are scaned before group maps and so
calling "useradd -g G hh_user" fails. Other solution may be direct writing to
config files (/etc/passwd, /etc/group).
<p>

<u>Note:</u> Adding user to some group is an act of editing a user, not a group.
<p>
-->

There is a problem: User wants to (1) change home dir of "hh" from "/home/hh" to
"/home/hh2" and (2) the home directory of "hh3" from "/home/hh3" to "home/hh".
It would work fine only when the second action would be executed first. How
should module react? Should it be banned at all?
<p>
<i>
Add,
Edit,
Delete
</i>
<p>
Gets its argumets, checks if the changes are possible and creates a user's or groups's map (in the style user_in_work) to be prapared for Users::Commit.
<p>
<i>Commit</i>
Writes the user's map to the global users/groups map. Checks if other changes 
should be done. For example, Commit was called with the parameters (`user,`edit,
$[... groups:"new_group" ... ]). Then Edit(`group) and Commit(`group) has to be 
called.
<p>
Many helper functions, just for data transformations - their names are mostly
self-descriptive:
<p>

<i>GetGid</i> - parameter groupname, returns gid
<p>
<i>GetUid</i> - parameter username, returns uid
<p>
<i>GetUser</i> - prameter uid, returns user's map
<p>

<!--
 (e.g. what: `user, name:"hh", uid:501, group: users) and runs
the apropriate write function (from routines.ycp).
: for regular users/groups it directly writes to
/etc/paswd and /etc/group (also creates home directory and does other necessary
actions), for LDAP uses extern adding/editing tool ("cpu useradd"), etc.
-->


<h4>routines.ycp functions</h4>

<i>ReadGshadowFromDisk, ReadShadowFromDisk, ReadPasswdFromDisk,
ReadGetentPasswd, ReadGroupFromDisk</i>
<p>
Functions for reading apropriate data file.
<p>
<i>WriteGshadowToDisk, WriteShadowToDisk, WritePasswdToDisk,
WriteGroupToDisk</i>
<p>
Functions for writing to apropriate data file.

<p>
<i>ReadLDAPUsers, ReadLDAPGroups</i>
<p>
Reading LDAP users/groups, probably via some extern tool ("cpu cat")
<p>
<i>WriteLDAPUsers, WriteLDAPGroups</i>
<p>
Write LDAP users/groups, probably via some extern tool ("cpu useradd")

<p>
<i>ReadLoginDefaults</i>
<p>
Reads /etc/defaults/useradd.
<p>

<i>WriteLoginDefaults</i>
<p>
Writes /etc/defaults/useradd (new feature).
<p>

<i>ReadSystemDefaults </i>
<p>
Read the settings from the system (pam stuff, /etc/login.defs, etc.)
<p>
<i>IsNisMaster</i> 
<p>
Check if we are NIS master by executing /usr/lib/yp/yphelper.
<p>
<i>ReadConfigurationType</i> 
<p>
In case of NIS master, ask which set of users to administer
<p>

<i>IsLDAPServer</i> 
<p>
Check if we are LDAP Server and editing LDAP users is possible.


<h4>UserCache functions</h4>

<i>Read</i> - here the lists and other module variables will be initialized.
<p>
<i>BuildHomeList</i> - creates list of home directories for futher checks
<p>
<i>BuildUsersList</i> - creates list of usernames
<p>
<i>BuildItemsList</i> - creates list of table items
<p>
<i>MergeTableItems</i> - merges the lists of currently used table items
<p>

<i>ChangeUser</i> - this is called from the User::Commit function to update
local (cache) lists.
<p>
<i>FindUsersBelongGroup</i>,
<i>UsernameExists</i>,
<i>NextFreeUid</i>
etc.

<h4>complex.ycp functions</h4>

<i>ReadDialog</i> - the first dialog in sequence, it calls Users::Read function
<p>

<i>WriteDialog</i> - the last dialog, calls Users::Write
<p>
<i>UsersDialog</i>
<p>
The main dialog. Shows the table with the customized set of users.
<p>
<i>GroupsDialog</i>
<p>
The main dialog for groups.

<h4>dialogs.ycp functions</h4>


<i>SetDefaultsDialog</i>
<p>
The "Defaults" dialog. Here user can change the values from 
/etc/default/useradd file.
<p>

<i>EditUserDialog</i>
<p>
Dialog for adding/editing a user. Various check function (from UserCache)
have to be run after entering the values into input fields; e.g. check if 
new username or home directory doesn't exist.
<br>
The changes made here and in Details dialog are stored to user's map (where
the "modified" flag is set) and function UserCache::AddUser or
UserCache::SetUser is called after clicking "Next".
<p>
<u>Note:</u> It is possible that for LDAP or other type of users there will be
some extra input fields here and/or in the Details dialog.

<p>
<i>EditUserDetailsDialog</i>
<p>
The Details dialog. User can change home directory, uid, default shell and group
membership. The changes are stored to user's map.
<p>
<i>DeleteUserDialog</i> - just check if possible + confirmation popup
<p>
<i>EditGroupDialog</i>
<p>
Dialog for adding/editing a group. Group name or gid can be changed and 
UserCache::SetGroup is called for the data modification. Also users can
be added or removed from this group.<!--, but this is counted as editing that user
and UserCache::SetUser is called than!-->
<p>
<i>DeleteGroupDialog</i> - just check if possible + confirmation popup

</body></html>
